<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPhone 價格查詢系統</title>
    <!-- 添加 worker 和核心文件的預加載 -->
    <link rel="preload" as="script" href="https://unpkg.com/tesseract.js@4.1.1/dist/worker.min.js">
    <link rel="preload" as="script" href="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js">
    <script src='https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js'></script>
    <style>
        /* 之前的 CSS 保持不變 */
    </style>
</head>
<body>
    <!-- HTML 結構保持不變 -->
    <script>
        // 初始化 Tesseract
        let worker = null;
        let scheduler = null;

        // 預加載 Tesseract worker
        async function initTesseract() {
            try {
                scheduler = Tesseract.createScheduler();
                worker = await Tesseract.createWorker('eng+chi_tra', 1);
                await scheduler.addWorker(worker);
                console.log('Tesseract initialized successfully');
            } catch (error) {
                console.error('Failed to initialize Tesseract:', error);
            }
        }

        // 頁面加載時初始化
        window.addEventListener('load', initTesseract);

        async function processImage(file) {
            const status = document.getElementById('status');
            const loading = document.querySelector('.loading');
            loading.style.display = 'block';
            status.textContent = '正在處理圖片...';
            updatedCells.clear();

            try {
                // 確保 worker 已初始化
                if (!worker || !scheduler) {
                    await initTesseract();
                }

                // 檢查文件類型
                if (!file.type.startsWith('image/')) {
                    throw new Error('請上傳圖片文件');
                }

                // 圖片預處理
                const image = await createImageBitmap(file);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // 調整圖片大小，優化處理效率
                const maxWidth = 1600;
                let width = image.width;
                let height = image.height;
                
                if (width > maxWidth) {
                    height = (maxWidth * height) / width;
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(image, 0, 0, width, height);

                // 將 canvas 轉換為 blob
                const blob = await new Promise(resolve => {
                    canvas.toBlob(resolve, 'image/jpeg', 0.8);
                });

                // 使用 Tesseract 識別文字
                const { data: { text } } = await scheduler.addJob('recognize', blob);
                
                const lines = text.split('\n');
                let updatedPrices = false;

                for (const line of lines) {
                    if (line.toLowerCase().includes('iphone')) {
                        const price = extractPrice(line);
                        if (!price) continue;

                        const capacityMatch = line.match(/(\d+(?:GB|TB))/i);
                        if (!capacityMatch) continue;
                        const capacity = capacityMatch[1].toUpperCase();

                        const normalizedLine = normalizeModelName(line);
                        
                        for (const [modelName, data] of Object.entries(models)) {
                            const normalizedModel = normalizeModelName(modelName);
                            
                            if (normalizedLine.includes(normalizedModel)) {
                                const capacityIndex = data.base.indexOf(capacity);
                                if (capacityIndex !== -1) {
                                    data.prices[capacityIndex] = price;
                                    updatedCells.add(`${modelName}-${capacity}`);
                                    updatedPrices = true;
                                }
                            }
                        }
                    }
                }

                if (updatedPrices) {
                    displayPrices();
                    status.textContent = '價格更新完成';
                } else {
                    status.textContent = '未能從圖片中識別出價格信息，請確保圖片清晰可讀';
                }

            } catch (error) {
                console.error('Image processing error:', error);
                status.textContent = '處理圖片時發生錯誤：' + (error.message || '請重試');
                
                // 重置 worker
                if (worker) {
                    await worker.terminate();
                    worker = null;
                    scheduler = null;
                    await initTesseract();
                }
            } finally {
                setTimeout(() => {
                    loading.style.display = 'none';
                }, 2000);
            }
        }

        // 文件上傳處理
        document.getElementById('imageInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            try {
                if (file.size > 10 * 1024 * 1024) {
                    throw new Error('圖片大小不能超過 10MB');
                }

                await processImage(file);
            } catch (error) {
                alert(error.message);
                this.value = ''; // 清空文件選擇
            }
        });

        // 其他函數保持不變
        // displayPrices(), extractPrice(), normalizeModelName() 等保持原樣

        // 初始顯示價格表
        displayPrices();
    </script>
</body>
</html>
