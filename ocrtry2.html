<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Locked Price Table</title>
    <link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        #result {
            margin-top: 20px;
            padding: 10px;
        }
        .loading {
            display: none;
            margin: 10px 0;
            color: #666;
        }
        .success-message {
            color: #4CAF50;
            font-weight: bold;
            margin: 10px 0;
            display: none;
        }
        .custom-file-upload {
            border: 2px solid #4CAF50;
            display: inline-block;
            padding: 10px 20px;
            cursor: pointer;
            background-color: white;
            color: #4CAF50;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .custom-file-upload:hover {
            background-color: #4CAF50;
            color: white;
        }
        input[type="file"] {
            display: none;
        }
        #tableContainer {
            margin-top: 20px;
            height: 600px;
            width: 100%;
        }
        h2 {
            color: #333;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Locked Price Table</h2>
        <label class="custom-file-upload">
            <input type="file" id="imageInput" accept="image/*">
            Choose File
        </label>
        <div class="loading" id="loading">Processing...</div>
        <div class="success-message" id="successMessage">Upload Success!</div>
        <h3>Result:</h3>
        <div id="tableContainer"></div>
    </div>

    <script src='https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js'></script>
    <script>
        const imageInput = document.getElementById('imageInput');
        const loading = document.getElementById('loading');
        const successMessage = document.getElementById('successMessage');
        const tableContainer = document.getElementById('tableContainer');

        function cleanModelName(modelName) {
            // 定義iPhone型號的標準名稱
            const standardModels = [
                'IPHONE 16',
                'IPHONE 16 PLUS',
                'IPHONE 16 PRO',
                'IPHONE 16 PRO MAX',
                'IPHONE 15',
                'IPHONE 15 PLUS',
                'IPHONE 15 PRO',
                'IPHONE 15 PRO MAX',
                'IPHONE 14',
                'IPHONE 14 PLUS',
                'IPHONE 14 PRO',
                'IPHONE 14 PRO MAX',
                'IPHONE 13 MINI',
                'IPHONE 13',
                'IPHONE 12',
                'IPHONE SE 3'
            ];

            // 尋找最匹配的標準型號名稱
            for (let standardModel of standardModels) {
                if (modelName.startsWith(standardModel)) {
                    return standardModel;
                }
            }
            return modelName;
        }

        function parseOCRResult(text) {
            const rows = [];
            const lines = text.split('\n');
            
            for (let line of lines) {
                if (line.includes('IPHONE')) {
                    const parts = line.trim().split(/\s+/);
                    let modelName = '';
                    let numbers = [];
                    
                    // 從後往前找數字
                    for (let i = parts.length - 1; i >= 0; i--) {
                        if (!isNaN(parts[i]) && numbers.length < 3) {
                            numbers.unshift(parseInt(parts[i]));
                        } else {
                            modelName = parts.slice(0, i + 1).join(' ');
                            break;
                        }
                    }

                    if (numbers.length === 3) {
                        rows.push([
                            cleanModelName(modelName.trim()),
                            numbers[0],
                            numbers[1],
                            numbers[2]
                        ]);
                    }
                }
            }
            return rows;
        }

        function createHandsontable(data) {
            const hot = new Handsontable(tableContainer, {
                data: data,
                colHeaders: ['LOCKED', 'SELLING', 'HKD', 'CUSTOMER'],
                rowHeaders: true,
                height: 'auto',
                width: 'auto',
                filters: true,
                dropdownMenu: true,
                licenseKey: 'non-commercial-and-evaluation',
                stretchH: 'all',
                className: 'htCenter',
                readOnly: true,
                columns: [
                    { type: 'text' },
                    { type: 'numeric', format: '0,0' },
                    { type: 'numeric', format: '0,0' },
                    { type: 'numeric', format: '0,0' }
                ]
            });
        }

        imageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            loading.style.display = 'block';
            successMessage.style.display = 'none';
            tableContainer.innerHTML = '';

            try {
                const { data: { text } } = await Tesseract.recognize(
                    file,
                    'eng',
                    {
                        logger: m => console.log(m)
                    }
                );
                
                const tableData = parseOCRResult(text);
                createHandsontable(tableData);
                
                successMessage.style.display = 'block';
                loading.style.display = 'none';
            } catch (error) {
                console.error('OCR Error:', error);
                loading.style.display = 'none';
            }
        });
    </script>
</body>
</html>
